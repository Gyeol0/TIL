# Subquery

## 서브쿼리란?

* SQL문 안에 포함된 다른 SQL문
* 서브쿼리는 메인 쿼리에 사용될 값을 반환하기 위해 사용
* SELECT, FROM , WHERE, HAVING 등 다양한 절에서 사용 가능
* 그러나 메인쿼리의 컬럼(변수)를 서브쿼리에서 사용할 수 있지만, 서브쿼리의 컬럼은 메인쿼리에서 사용불가
  * 자바의 {}와 비슷
* 단일 행을 반환하면 단일 행 서브쿼리(>, <, 값 비교)
  * 단일 행 비교연산자를 사용
* 다중 행을 반환하면 다중 행 서브쿼리
  * 다중 행 비교연산자 사용

```sql
SELECT (Subquery)
FROM EMPLOYEE
WHERE DEPT_ID = '10'
```

* 보통 쿼리문과 똑같이 작성
* ()안에 작성하고, ORDER BY와 ; 사용 x
* 만약 표현식(EXP) 안에 사용한다면, 반환 값과 요구사항이 일치해야함
  * 다중 행인지, 단일 행인지
  * WHERE (Subquery) <= 10 인데 다중 행 사용하면 에러

### 작성 순서

1. 메인 쿼리 작성
2. 조건에 따라 서브 쿼리 작성
3. 쿼리문 연결



## 연산

### 단일 행

* 단일 행 비교연산자를 사용하려면 서브쿼리의 반환 값도 단일 행이어야 한다
  * <, >, = 등

```sql
SELECT EMP_ID
FROM SKILL_SCORE
WHERE 10 <= (SELECT MAX(SCORE)
            FROM SKILL_SCORE);
```

* 서브쿼리 안에 서브쿼리 작성 가능



### 다중 행

* 서브쿼리 결과 값이 여러 개
  * IN, NOT IN, ANY, ALL, EXITS, NOT EXITS 등

#### NOT  IN

* NOT IN 연산자와 다중 행 서브쿼리를 사용할 때, 서브쿼리 결과에 NULL이 포함되어 있으면 전체 결과가 NULL이 됨
  * WHERE EMP_ID NOT IN (서브쿼리 결과 : 'A', 'B', .... NULL)
  * IS NOT NULL로 한 번 걸러줘야함

#### ANY

* 특정 값이 아니라 범위로 비교
* 서브쿼리 반환 값중 어떤 것이라도 만족하면 성립
* 10 < ANY(Subquery) 하면 서브쿼리 반환 값 중 최댓값이 10보다 크면 성립
* 10 > ANY(Subquery) 하면 서브쿼리 반환 값 중 최솟값이 10보다 작으면 성립

#### ALL

* 특정 값이 아니라 범위로 비교
* 서브쿼리 모든 반환 값이 만족하면 성립
* 10 < ALL(Subquery) 하면 서브쿼리 반환 값 중 최솟값이 10보다 크면 성립
* 10 > ALL(Subquery) 하면 서브쿼리 반환 값 중 최댓값이 10보다 작으면 성립

#### EXITS

* 서브쿼리 반환 값 존재 유무 판단
* 존재 여부 확인이 목적이기 때문에 서브쿼리 내에 특정 값 조회(SELECT) 필요 없음
* 존재하면 TRUE 반환

```sql
SELECT EMP_ID
	, EMP_NAME
FROM EMPLOYEE E
WHERE EXISTS (SELECT NULL 
				FROM EMPLOYEE
				WHERE E.EMP_ID = SUPERVISOR_EMP_ID)

```

* 관리자번호와 사원번호 비교, 존재하면 TRUE
* 메인쿼리의 관리자 ID가 있는지 확인하기 위해 새로운 EMPLOYEE 테이블의 EMP_ID와 비교
  * 굳이 이렇게 할 필요 있나
  * IS NOT NULL 하면 되는 듯?

### NOT EXITS

* 서브쿼리 반환 값 존재 유무 판단
* 존재 여부 확인이 목적이기 때문에 서브쿼리 내에 특정 값 조회(SELECT) 필요 없음
* 존재하지 않으면 TRUE 반환
* EXITS와 반대



